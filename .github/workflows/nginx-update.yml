name: Check Nginx Updates

on:
  schedule:
    - cron: '0 9 * * 0'  # Jeden Sonntag um 9:00 Uhr
  workflow_dispatch:  # Manuell触发
  repository_dispatch:
    types: [nginx-update]

jobs:
  check-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4

      - name: Extract current Nginx version
        id: current
        run: |
          # Extract nginx version from Dockerfile
          CURRENT=$(grep -oP 'nginx:\K[^\s]+' Dockerfile || grep -oP 'FROM nginx:\K[^\s]+' Dockerfile)
          CURRENT_VERSION=$(echo "$CURRENT" | head -1)
          
          if [ -z "$CURRENT_VERSION" ]; then
            echo "Could not find nginx version in Dockerfile"
            exit 1
          fi
          
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Found current version: $CURRENT_VERSION"

      - name: Fetch latest Nginx version
        id: latest
        run: |
          # Get latest stable version from Docker Hub
          LATEST=$(curl -s "https://hub.docker.com/v2/repositories/library/nginx/tags" \
            | jq -r '.results[] | select(.name == "stable") | .name')
          
          if [ -z "$LATEST" ]; then
            # Fallback to mainline if stable not found
            LATEST=$(curl -s "https://hub.docker.com/v2/repositories/library/nginx/tags" \
              | jq -r '.results[0].name')
          fi
          
          echo "version=$LATEST" >> $GITHUB_OUTPUT
          echo "Latest version: $LATEST"

      - name: Compare versions
        id: compare
        run: |
          CURRENT="${{ steps.current.outputs.version }}"
          LATEST="${{ steps.latest.outputs.version }}"
          
          echo "Comparing $CURRENT with $LATEST"
          
          if [ "$CURRENT" = "$LATEST" ]; then
            echo "update_available=false" >> $GITHUB_OUTPUT
            echo "No update available (already on $CURRENT)"
          else
            echo "update_available=true" >> $GITHUB_OUTPUT
            echo "Update available: $CURRENT -> $LATEST"
          fi

      - name: Create Pull Request
        if: steps.compare.outputs.update_available == 'true'
        uses: actions/create-pull-request@v7
        with:
          title: 'chore: Update Nginx from ${{ steps.current.outputs.version }} to ${{ steps.latest.outputs.version }}'
          body: |
            ## Update available
            - **Current:** `${{ steps.current.outputs.version }}`
            - **Latest:** `${{ steps.latest.outputs.version }}`
            
            This PR updates the Nginx base image in `Dockerfile`.
            
            ### Checklist
            - [ ] Test the application locally
            - [ ] Verify nginx config syntax: `nginx -t`
            - [ ] Check for breaking changes in [Nginx Changelog](https://nginx.org/en/CHANGES)
            
            ---
            *Auto-generated by GitHub Actions*
          branch: nginx-update-${{ steps.latest.outputs.version }}
          commit-message: 'chore: update nginx to ${{ steps.latest.outputs.version }}'
          delete-branch: true

      - name: No update needed
        if: steps.compare.outputs.update_available == 'false'
        run: |
          echo "Nginx is already up to date at version ${{ steps.current.outputs.version }}"
